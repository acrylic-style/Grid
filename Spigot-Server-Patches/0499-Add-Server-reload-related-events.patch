From cfe8d95724327ddbf0faf50b4e896f552c9bcaee Mon Sep 17 00:00:00 2001
From: acrylic-style <me@acrylicstyle.xyz>
Date: Wed, 29 Apr 2020 21:37:37 +0900
Subject: [PATCH] Add Server reload related events


diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index f49193d9..5342490e 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -119,6 +119,7 @@ import org.bukkit.craftbukkit.command.BukkitCommandWrapper;
 import org.bukkit.craftbukkit.command.CraftCommandMap;
 import org.bukkit.craftbukkit.command.VanillaCommandWrapper;
 import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
 import org.bukkit.craftbukkit.generator.CraftChunkData;
 import org.bukkit.craftbukkit.help.SimpleHelpMap;
 import org.bukkit.craftbukkit.inventory.CraftBlastingRecipe;
@@ -199,6 +200,8 @@ import org.yaml.snakeyaml.constructor.SafeConstructor;
 import org.yaml.snakeyaml.error.MarkedYAMLException;
 
 import net.md_5.bungee.api.chat.BaseComponent; // Spigot
+import xyz.acrylicstyle.paper.event.server.ServerPreReloadEvent;
+import xyz.acrylicstyle.paper.event.server.ServerReloadedEvent;
 
 import javax.annotation.Nullable; // Paper
 import javax.annotation.Nonnull; // Paper
@@ -771,6 +774,7 @@ public final class CraftServer implements Server {
 
     @Override
     public void reload() {
+        if (CraftEventFactory.callServerPreReloadEvent()) return; // Paper - cancel reload when the evnet was cancelled
         org.spigotmc.WatchdogThread.hasStarted = false; // Paper - Disable watchdog early timeout on reload
         reloadCount++;
         configuration = YamlConfiguration.loadConfiguration(getConfigFile());
@@ -885,6 +889,7 @@ public final class CraftServer implements Server {
         enablePlugins(PluginLoadOrder.POSTWORLD);
         getPluginManager().callEvent(new ServerLoadEvent(ServerLoadEvent.LoadType.RELOAD));
         org.spigotmc.WatchdogThread.hasStarted = true; // Paper - Disable watchdog early timeout on reload
+        getPluginManager().callEvent(new ServerReloadedEvent()); // Paper - Add simple event to avoid bugs
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 9757391f..490c0497 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -73,6 +73,7 @@ import org.bukkit.Statistic.Type;
 import org.bukkit.block.Block;
 import org.bukkit.block.BlockFace;
 import org.bukkit.block.BlockState;
+import org.bukkit.command.CommandSender;
 import org.bukkit.craftbukkit.CraftRaid;
 import org.bukkit.craftbukkit.CraftServer;
 import org.bukkit.craftbukkit.CraftStatistic;
@@ -206,8 +207,10 @@ import org.bukkit.inventory.meta.BookMeta;
 import org.bukkit.potion.PotionEffect;
 
 import org.bukkit.event.entity.SpawnerSpawnEvent; // Spigot
+import xyz.acrylicstyle.paper.event.command.ReloadCommandEvent;
 import xyz.acrylicstyle.paper.event.server.PluginSendActionBarEvent;
 import xyz.acrylicstyle.paper.event.server.PluginSendMessageEvent;
+import xyz.acrylicstyle.paper.event.server.ServerPreReloadEvent;
 
 public class CraftEventFactory {
     public static final DamageSource MELTING = CraftDamageSource.copyOf(DamageSource.BURN);
@@ -1688,14 +1691,8 @@ public class CraftEventFactory {
     }
 
     // Paper start
-    public static boolean callPluginSendMessageEvent(Player player, String message) {
-        PluginSendMessageEvent event = new PluginSendMessageEvent(player, message);
-        Bukkit.getPluginManager().callEvent(event);
-        return event.isCancelled();
-    }
-
-    public static boolean callPluginSendActionBarEvent(Player player, String message) {
-        PluginSendActionBarEvent event = new PluginSendActionBarEvent(player, message);
+    public static boolean callServerPreReloadEvent() {
+        ServerPreReloadEvent event = new ServerPreReloadEvent();
         Bukkit.getPluginManager().callEvent(event);
         return event.isCancelled();
     }
-- 
2.21.0.windows.1

