From 791c7c4f8e173e8287889c388039a74e9f06d26d Mon Sep 17 00:00:00 2001
From: acrylic-style <me@acrylicstyle.xyz>
Date: Wed, 29 Apr 2020 23:42:40 +0900
Subject: [PATCH] Fix MC-146524 partially (again)


diff --git a/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java b/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
index 7315130df..b98968908 100644
--- a/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
+++ b/src/main/java/net/minecraft/server/PathfinderGoalNearestAttackableTarget.java
@@ -16,7 +16,7 @@ public class PathfinderGoalNearestAttackableTarget<T extends EntityLiving> exten
     }
 
     public PathfinderGoalNearestAttackableTarget(EntityInsentient entityinsentient, Class<T> oclass, boolean flag, boolean flag1) {
-        // Paper start - Fix MC-146524
+        // Paper start - Partial fix of MC-146524 (seems not working well)
         this(entityinsentient, oclass, 10, flag, flag1, entity -> {
             if (entity instanceof EntityPlayer) {
                 EnumGamemode gamemode = ((EntityPlayer) entity).playerInteractManager.getGameMode();
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 4621b1db9..1363edd37 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -220,7 +220,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     public void sendRawMessage(String message) {
         if (getHandle().playerConnection == null) return;
         // Paper start - implement PluginSendStringMessageEvent
-        PluginSendMessageEvent event = new PluginSendMessageEvent(this, message);
+        PluginSendMessageEvent event = server.isPrimaryThread() ? new PluginSendMessageEvent(this, message) : new PluginSendMessageEvent(true, this, message);
         getServer().getPluginManager().callEvent(event);
         if (event.isCancelled()) return;
         // Paper end
@@ -248,7 +248,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     public void sendActionBar(String message) {
         if (getHandle().playerConnection == null || message == null || message.isEmpty()) return;
         // Paper start - implement PluginSendActionBarEvent
-        PluginSendActionBarEvent event = new PluginSendActionBarEvent(this, message);
+        PluginSendActionBarEvent event = server.isPrimaryThread() ? new PluginSendActionBarEvent(this, message) : new PluginSendActionBarEvent(true, this, message);
         getServer().getPluginManager().callEvent(event);
         if (event.isCancelled()) return;
         getHandle().playerConnection.sendPacket(new PacketPlayOutChat(new net.minecraft.server.ChatComponentText(event.getMessage()), net.minecraft.server.ChatMessageType.GAME_INFO));
-- 
2.21.0.windows.1

