From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: acrylic-style <me@acrylicstyle.xyz>
Date: Thu, 30 Apr 2020 19:24:40 +0900
Subject: [PATCH] SPIGOT-809 Recipients for join and quit messages.

https://hub.spigotmc.org/jira/projects/SPIGOT/issues/SPIGOT-809

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 19be6a93cf2bc7541054a67217391095c2063921..9bc98c05b3e5112e75a9d312d78368a2331cd11e 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -12,6 +12,7 @@ import java.util.Collections;
 import java.util.Iterator;
 import java.util.Optional;
 import java.util.Set;
+import java.util.function.Consumer;
 import java.util.stream.Stream;
 import javax.annotation.Nullable;
 import org.apache.commons.lang3.StringEscapeUtils;
@@ -49,6 +50,7 @@ import org.bukkit.event.player.PlayerInteractEntityEvent;
 import org.bukkit.event.player.PlayerItemHeldEvent;
 import org.bukkit.event.player.PlayerKickEvent;
 import org.bukkit.event.player.PlayerMoveEvent;
+import org.bukkit.event.player.PlayerQuitEvent;
 import org.bukkit.event.player.PlayerResourcePackStatusEvent;
 import org.bukkit.event.player.PlayerSwapHandItemsEvent;
 import org.bukkit.event.player.PlayerTeleportEvent;
@@ -1591,9 +1593,18 @@ public class PlayerConnection implements PacketListenerPlayIn {
         */
 
         this.player.p();
-        String quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);
-        if ((quitMessage != null) && (quitMessage.length() > 0)) {
-            this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage));
+        PlayerQuitEvent quitMessage = this.minecraftServer.getPlayerList().disconnect(this.player);
+        IChatBaseComponent[] chatMessage = CraftChatMessage.fromString(quitMessage.getQuitMessage());
+        if (this.player.didPlayerJoinEvent && (quitMessage.getQuitMessage() != null) && (quitMessage.getQuitMessage().length() > 0)) { // Paper - don't print quit if we never printed join
+            // Paper start - Recipients for join and quit messages. (SPIGOT-809)
+            quitMessage.getRecipients().forEach(new Consumer<Player>() {
+                @Override
+                public void accept(Player player) {
+                    ((org.bukkit.craftbukkit.entity.CraftPlayer) player).getHandle().sendMessage(chatMessage);
+                }
+            });
+            // Paper end
+            this.minecraftServer.getPlayerList().sendMessage(CraftChatMessage.fromString(quitMessage.getQuitMessage()));
         }
         // CraftBukkit end
         if (this.isExemptPlayer()) {
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index 9382e8f79e8edec8885c629a36e230fbec50e1fb..146e2c7478dfd7bb0b98755c6df37add61114d3d 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -18,6 +18,7 @@ import java.util.Map;
 import java.util.Optional;
 import java.util.Set;
 import java.util.UUID;
+import java.util.function.Consumer; // Paper
 import javax.annotation.Nullable;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
@@ -280,7 +281,16 @@ public abstract class PlayerList {
 
         if (joinMessage != null && joinMessage.length() > 0) {
             // Paper start - Removed sendAll for loop and broadcasted to console also
-            server.getPlayerList().sendMessage(CraftChatMessage.fromString(joinMessage));
+            // Paper start - Recipients for join and quit messages. (SPIGOT-809)
+            IChatBaseComponent[] chatMessage = CraftChatMessage.fromString(joinMessage);
+            server.sendMessage(chatmessage, SystemUtils.getNullUUID());
+            playerJoinEvent.getRecipients().forEach(new Consumer<Player>() {
+                @Override
+                public void accept(Player player) {
+                    ((org.bukkit.craftbukkit.entity.CraftPlayer) player).getHandle().sendMessage(chatMessage);
+                }
+            });
+            // Paper end
             // Paper end
         }
         // CraftBukkit end
@@ -497,7 +507,7 @@ public abstract class PlayerList {
 
     }
 
-    public String disconnect(EntityPlayer entityplayer) { // CraftBukkit - return string
+    public PlayerQuitEvent disconnect(EntityPlayer entityplayer) { // CraftBukkit - return string // Paper - return PlayerQuitEvent
         WorldServer worldserver = entityplayer.getWorldServer();
 
         entityplayer.a(StatisticList.LEAVE_GAME);
@@ -583,7 +593,7 @@ public abstract class PlayerList {
         cserver.getScoreboardManager().removePlayer(entityplayer.getBukkitEntity());
         // CraftBukkit end
 
-        return entityplayer.didPlayerJoinEvent ? playerQuitEvent.getQuitMessage() : null; // CraftBukkit // Paper - don't print quit if we never printed join
+        return playerQuitEvent; // CraftBukkit // Paper - don't print quit if we never printed join // Paper - return PlayerQuitEvent
     }
 
     // CraftBukkit start - Whole method, SocketAddress to LoginListener, added hostname to signature, return EntityPlayer
